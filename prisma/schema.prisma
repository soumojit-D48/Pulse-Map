


generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // Connection URLs for Migrate / Prisma Client have been moved to prisma.config.ts
  // See: https://pris.ly/d/config-datasource and https://pris.ly/d/prisma7-client-config
}


// datasource db {
//   provider  = "postgresql"
//   // url       = env("DATABASE_URL")
//   // directUrl = env("DIRECT_URL")
// }

// ============================================
// 1. PROFILE TABLE (User Information)
// ============================================
model Profile {
  id               String    @id @default(cuid())
  clerkId          String    @unique        // Links to Clerk authentication
  email            String    @unique
  name             String
  phone            String?
  bloodGroup       BloodGroup
  age              Int
  gender           Gender
  
  // Enhanced location fields
  state            String
  city             String
  latitude         Float
  longitude        Float
  locationName     String    // Full address or landmark
  
  // Donor availability
  available        Boolean   @default(false)
  lastDonationDate DateTime?
  
  role             Role      @default(DONOR)
  avatarUrl        String?
  profileCompleted Boolean   @default(false)
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  // Relations
  donationsGiven   Donation[] 
  requestsCreated  Request[]  @relation("RequestCreator")
  responses        Response[]

  notifications    Notification[]
  
  @@index([clerkId])
  @@index([bloodGroup])
  @@index([available])
  @@index([latitude, longitude])
  @@index([state, city])
  @@map("profiles")
}

// ============================================
// 2. REQUEST TABLE (Emergency Blood Requests)
// ============================================
model Request {
  id                  String    @id @default(cuid())
  
  createdById         String
  createdBy           Profile   @relation("RequestCreator", fields: [createdById], references: [id], onDelete: Cascade)
  
  bloodGroup          BloodGroup
  patientName         String
  
  // Patient location
  patientLatitude     Float
  patientLongitude    Float
  patientLocationName String
  
  contactPhone        String
  urgency             Urgency   @default(MEDIUM)
  unitsNeeded         Int       @default(1)
  hospitalName        String?
  notes               String?   @db.Text
  
  status              RequestStatus @default(ACTIVE)
  fulfilledAt         DateTime?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Relations
  responses           Response[]
  donations           Donation[]

  notifications    Notification[]
  
  @@index([createdById])
  @@index([status])
  @@index([bloodGroup])
  @@index([patientLatitude, patientLongitude])
  @@map("requests")
}

// ============================================
// 3. DONATION TABLE (Donation History)
// ============================================
model Donation {
  id           String    @id @default(cuid())
  
  donorId      String
  donor        Profile   @relation(fields: [donorId], references: [id], onDelete: Cascade)
  
  requestId    String?
  request      Request?  @relation(fields: [requestId], references: [id], onDelete: SetNull)
  
  donationDate DateTime  @db.Date
  unitsDonated Int       @default(1)
  hospitalName String?
  notes        String?   @db.Text
  
  createdAt    DateTime  @default(now())
  
  @@index([donorId])
  @@index([donationDate])
  @@map("donations")
}

// ============================================
// 4. RESPONSE TABLE (Donor Responses to Requests)
// ============================================
model Response {
  id        String    @id @default(cuid())
  
  requestId String
  request   Request   @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  donorId   String
  donor     Profile   @relation(fields: [donorId], references: [id], onDelete: Cascade)
  
  status    ResponseStatus @default(PENDING)
  message   String?   @db.Text // any msg the donor can send to the reciver 
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  notifications    Notification[]
  
  @@unique([requestId, donorId])
  @@index([requestId])
  @@index([donorId])
  @@map("responses")
}


// ============================================
// 5. NOTIFICATION TABLE (In-App Notifications)
// ============================================
model Notification {
  id        String   @id @default(cuid())
  
  userId    String
  user      Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      NotificationType
  title     String
  message   String   @db.Text
  link      String?  // URL to redirect when clicked
  
  read      Boolean  @default(false)
  readAt    DateTime?
  
  // Optional: Link to related entities
  requestId String?
  request   Request? @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  responseId String?
  response   Response? @relation(fields: [responseId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  NEW_REQUEST_NEARBY    // New blood request in your area
  REQUEST_RESPONSE      // Someone responded to your request
  RESPONSE_ACCEPTED     // Your response was accepted
  RESPONSE_DECLINED     // Your response was declined
  REQUEST_FULFILLED     // Request you responded to is fulfilled
  REQUEST_CANCELLED     // Request was cancelled
  DONATION_REMINDER     // Reminder that you can donate again
  PROFILE_INCOMPLETE    // Reminder to complete profile
  SYSTEM_ANNOUNCEMENT   // Admin announcements
}

// ============================================
// ENUMS
// ============================================

enum BloodGroup {
  A_POSITIVE  @map("A+")
  A_NEGATIVE  @map("A-")
  B_POSITIVE  @map("B+")
  B_NEGATIVE  @map("B-")
  AB_POSITIVE @map("AB+")
  AB_NEGATIVE @map("AB-")
  O_POSITIVE  @map("O+")
  O_NEGATIVE  @map("O-")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Role {
  DONOR
  RECIPIENT
  ADMIN
}

enum Urgency {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum RequestStatus {
  ACTIVE
  FULFILLED
  CANCELLED
}

enum ResponseStatus {
  PENDING
  ACCEPTED
  DECLINED
}